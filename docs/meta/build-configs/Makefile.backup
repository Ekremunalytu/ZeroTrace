# ZeroTrace - Cross-Platform Development Environment
# Usage: make <target>
#
# This Makefile provides a unified interface for all development tasks
# and automatically detects the best environment (container vs local).

.PHONY: help setup start stop shell build test clean lint format security status reset

# Default target
.DEFAULT_GOAL := help

# Colors for output
BLUE := \033[36m
GREEN := \033[32m
RED := \033[31m
YELLOW := \033[33m
CYAN := \033[96m
RESET := \033[0m

# Cross-platform detection
UNAME_S := $(shell uname -s)
ifeq ($(UNAME_S),Linux)
    PLATFORM := linux
endif
ifeq ($(UNAME_S),Darwin)
    PLATFORM := macos
endif
ifeq ($(findstring CYGWIN,$(UNAME_S)),CYGWIN)
    PLATFORM := windows
endif
ifeq ($(findstring MINGW,$(UNAME_S)),MINGW)
    PLATFORM := windows
endif

# Development wrapper script
DEV_SCRIPT := ./dev

help: ## Show this help message
	@echo "$(CYAN)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(RESET)"
	@echo "$(CYAN)â•‘                     ðŸ›¡ï¸  ZeroTrace XDR                      â•‘$(RESET)"
	@echo "$(CYAN)â•‘                Cross-Platform Development                    â•‘$(RESET)"
	@echo "$(CYAN)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(RESET)"
	@echo ""
	@echo "$(GREEN)Environment Commands:$(RESET)"
	@awk 'BEGIN {FS = ":.*## "} /^[a-zA-Z_-]+:.*## / { printf "  $(BLUE)%-15s$(RESET) %s\n", $$1, $$2 }' $(MAKEFILE_LIST) | grep -E "(setup|start|stop|shell|status|reset)"
	@echo ""
	@echo "$(GREEN)Development Commands:$(RESET)"
	@awk 'BEGIN {FS = ":.*## "} /^[a-zA-Z_-]+:.*## / { printf "  $(BLUE)%-15s$(RESET) %s\n", $$1, $$2 }' $(MAKEFILE_LIST) | grep -E "(build|test|clean|lint|format|security)"
	@echo ""
	@echo "$(YELLOW)Quick Start (Platform: $(PLATFORM)):$(RESET)"
	@echo "  1. make setup     # Setup development environment"
	@echo "  2. make start     # Start development environment"  
	@echo "  3. make build     # Build all components"
	@echo "  4. make test      # Run tests"
	@echo "  5. make shell     # Open development shell"
	@echo ""

## ðŸ› ï¸ DEVELOPMENT SETUP

dev-setup: ## Setup complete development environment
	@echo "$(GREEN)Setting up development environment...$(RESET)"
	pip install -e ".[dev]"
	pre-commit install
	@echo "$(GREEN)âœ“ Development environment ready!$(RESET)"

## ðŸš€ MAIN COMMANDS (One-Click Operations)

up: ## ðŸš€ Start all services (One-Click Start)
	@echo "$(GREEN)Starting ZeroTrace development environment...$(RESET)"
	@if [ ! -f .env ]; then \
		echo "$(YELLOW)Creating .env file from template...$(RESET)"; \
		cp .env.example .env; \
	fi
	docker-compose up -d
	@echo "$(GREEN)âœ… Environment started!$(RESET)"
	@echo ""
	@echo "$(BLUE)Available services:$(RESET)"
	@echo "  ðŸŒ RabbitMQ Management: http://localhost:15672 (zerotrace/zerotrace_dev_pass)"
	@echo "  ðŸ—„ï¸  pgAdmin:            http://localhost:5050 (admin@zerotrace.local/admin)"
	@echo "  ðŸ“§ MailHog:            http://localhost:8025"
	@echo "  ðŸ”§ API:                http://localhost:8000"
	@echo "  ðŸŽ¨ UI:                 http://localhost:3000"
	@echo ""
	@echo "$(YELLOW)Next steps:$(RESET)"
	@echo "  make init    # Initialize database and services"
	@echo "  make shell   # Enter development container"

down: ## ðŸ›‘ Stop all services
	@echo "$(RED)Stopping ZeroTrace environment...$(RESET)"
	docker-compose down
	@echo "$(GREEN)âœ… Environment stopped!$(RESET)"

init: ## ðŸ—ï¸ Initialize development environment
	@echo "$(GREEN)Initializing development environment...$(RESET)"
	docker-compose exec devcontainer dev-helper init
	@echo "$(GREEN)âœ… Environment initialized!$(RESET)"

build: ## ðŸ”¨ Build all C++ components
	@echo "$(GREEN)Building C++ components...$(RESET)"
	docker-compose exec devcontainer dev-helper build
	@echo "$(GREEN)âœ… Build completed!$(RESET)"

rebuild: ## ðŸ”„ Rebuild containers and restart
	@echo "$(YELLOW)Rebuilding containers...$(RESET)"
	docker-compose down
	docker-compose build --no-cache
	docker-compose up -d
	@echo "$(GREEN)âœ… Rebuild completed!$(RESET)"

## ðŸ“Š MONITORING & DEBUGGING

logs: ## ðŸ“‹ Show logs (live tail)
	@echo "$(BLUE)Showing live logs (Ctrl+C to exit)...$(RESET)"
	docker-compose logs -f

logs-service: ## ðŸ“‹ Show logs for specific service (make logs-service SERVICE=postgres)
	@echo "$(BLUE)Showing logs for $(SERVICE)...$(RESET)"
	docker-compose logs -f $(SERVICE)

status: ## ðŸ“Š Show service status
	@echo "$(BLUE)Service Status:$(RESET)"
	@docker-compose ps
	@echo ""
	@echo "$(BLUE)Health Status:$(RESET)"
	@docker-compose exec devcontainer dev-helper status 2>/dev/null || echo "$(RED)Development container not running$(RESET)"

shell: ## ðŸš Enter development container shell
	@echo "$(GREEN)Entering development container...$(RESET)"
	docker-compose exec devcontainer /bin/bash

shell-service: ## ðŸš Enter specific service shell (make shell-service SERVICE=postgres)
	@echo "$(GREEN)Entering $(SERVICE) container...$(RESET)"
	docker-compose exec $(SERVICE) /bin/bash

## ðŸ§ª DEVELOPMENT & TESTING

test: ## ðŸ§ª Run all tests
	@echo "$(GREEN)Running tests...$(RESET)"
	docker-compose exec devcontainer dev-helper test

start-api: ## ðŸŒ Start API service in development mode
	@echo "$(GREEN)Starting API service...$(RESET)"
	docker-compose exec devcontainer dev-helper start-api

start-ui: ## ðŸŽ¨ Start UI service in development mode
	@echo "$(GREEN)Starting UI service...$(RESET)"
	docker-compose exec devcontainer dev-helper start-ui

start-collector: ## ðŸ“Š Start process collector
	@echo "$(GREEN)Starting process collector...$(RESET)"
	docker-compose exec devcontainer dev-helper start-collector

## ðŸ§¹ MAINTENANCE

clean: ## ðŸ§¹ Clean build artifacts
	@echo "$(YELLOW)Cleaning build artifacts...$(RESET)"
	docker-compose exec devcontainer dev-helper clean
	@echo "$(GREEN)âœ… Cleanup completed!$(RESET)"

clean-all: ## ðŸ—‘ï¸ Clean everything (containers, volumes, images)
	@echo "$(RED)âš ï¸  This will remove ALL containers, volumes, and images!$(RESET)"
	@read -p "Are you sure? (y/N): " confirm && [ "$$confirm" = "y" ] || exit 1
	docker-compose down -v --remove-orphans
	docker system prune -af --volumes
	@echo "$(GREEN)âœ… Complete cleanup finished!$(RESET)"

reset: ## ðŸ”„ Reset entire environment (clean + rebuild)
	@echo "$(YELLOW)Resetting entire environment...$(RESET)"
	$(MAKE) down
	$(MAKE) clean-all
	$(MAKE) up
	$(MAKE) init
	@echo "$(GREEN)âœ… Environment reset completed!$(RESET)"

## ðŸ”’ SECURITY COMMANDS

security-check: ## ðŸ”’ Run comprehensive security check
	@echo "$(GREEN)Running security checks...$(RESET)"
	./scripts/security-check.sh

security-scan: ## ðŸ” Scan dependencies for vulnerabilities  
	@echo "$(GREEN)Scanning dependencies for vulnerabilities...$(RESET)"
	python3 -m pip install safety
	safety check
	@echo "$(GREEN)âœ… Security scan completed!$(RESET)"

secrets-check: ## ðŸ•µï¸ Check for hardcoded secrets
	@echo "$(GREEN)Scanning for secrets...$(RESET)"
	@if [ ! -f ".secrets.baseline" ]; then \
		echo "Creating secrets baseline..."; \
		detect-secrets scan --baseline .secrets.baseline; \
	fi
	detect-secrets scan --baseline .secrets.baseline --exclude-files '\.env\.example$$'
	@echo "$(GREEN)âœ… Secrets check completed!$(RESET)"

fix-permissions: ## ðŸ”§ Fix file permissions
	@echo "$(GREEN)Fixing file permissions...$(RESET)"
	chmod +x scripts/*.sh
	chmod +x infrastructure/docker/scripts/*
	chmod 600 configs/*/security.env 2>/dev/null || true
	chmod 600 .env 2>/dev/null || true
	@echo "$(GREEN)âœ… Permissions fixed!$(RESET)"

## ðŸš€ PRODUCTION COMMANDS

prod-build: ## ðŸ—ï¸ Build production images
	@echo "$(GREEN)Building production images...$(RESET)"
	docker-compose -f docker-compose.prod.yml build
	@echo "$(GREEN)âœ… Production images built!$(RESET)"

## ðŸ“¦ PRODUCTION COMMANDS

prod-up: ## ðŸš€ Start production environment
	@echo "$(GREEN)Starting production environment...$(RESET)"
	docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

prod-logs: ## ðŸ“‹ Show production logs
	docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs -f

## ðŸ”§ UTILITY COMMANDS

backup-db: ## ðŸ’¾ Backup database
	@echo "$(GREEN)Creating database backup...$(RESET)"
	@mkdir -p backups
	docker-compose exec postgres pg_dump -U zerotrace zerotrace > backups/zerotrace_$(shell date +%Y%m%d_%H%M%S).sql
	@echo "$(GREEN)âœ… Database backup created in backups/ folder$(RESET)"

restore-db: ## ðŸ“¥ Restore database (make restore-db FILE=backup.sql)
	@echo "$(YELLOW)Restoring database from $(FILE)...$(RESET)"
	@if [ ! -f "$(FILE)" ]; then echo "$(RED)File $(FILE) not found!$(RESET)"; exit 1; fi
	docker-compose exec -T postgres psql -U zerotrace -d zerotrace < $(FILE)
	@echo "$(GREEN)âœ… Database restored!$(RESET)"

update: ## ðŸ”„ Update all Docker images
	@echo "$(GREEN)Updating Docker images...$(RESET)"
	docker-compose pull
	@echo "$(GREEN)âœ… Images updated!$(RESET)"

## ðŸ“‹ INFORMATION

info: ## â„¹ï¸ Show environment information
	@echo "$(BLUE)ZeroTrace Development Environment Info$(RESET)"
	@echo ""
	@echo "$(GREEN)Project Structure:$(RESET)"
	@echo "  ðŸ“ services/     - Microservices source code"
	@echo "  ðŸ³ infrastructure/ - Docker & deployment files"
	@echo "  ðŸ“Š data/         - Persistent data storage"
	@echo "  âš™ï¸ configs/      - Configuration files"
	@echo ""
	@echo "$(GREEN)Key Files:$(RESET)"
	@echo "  ðŸ³ docker-compose.yml    - Main orchestration"
	@echo "  âš™ï¸ .env                  - Environment variables"
	@echo "  ðŸ”¨ Makefile              - This file"
	@echo "  ðŸ“‹ PROJECT_STRUCTURE.md  - Detailed documentation"
	@echo ""
	@echo "$(GREEN)Quick Commands:$(RESET)"
	@echo "  make up && make init     - Start everything"
	@echo "  make shell               - Enter dev container"
	@echo "  make logs                - Watch all logs"
	@echo "  make clean               - Clean build files"
